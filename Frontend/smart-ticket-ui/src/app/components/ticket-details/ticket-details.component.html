<div class="details-container" *ngIf="ticket; else loadingOrError">

    <!-- SLA Breach Banner -->
    <div class="breach-banner fadeIn" *ngIf="ticket.isEscalated">
        <mat-icon>warning</mat-icon>
        <span><strong>SLA BREACH:</strong> This ticket has exceeded its resolution time limit and has been
            escalated.</span>
    </div>

    <!-- Header Section -->
    <mat-card class="ticket-header-card fadeIn">
        <div class="header-row">
            <div>
                <h1 class="ticket-title">
                    <span class="id-badge">#{{ticket.ticketId}}</span> {{ticket.title}}
                </h1>
                <div class="meta-row">
                    <span class="badge priority" [ngClass]="getPriorityClass(ticket.priority)">
                        {{ticket.priority}} Priority
                    </span>
                    <span class="badge status" [ngClass]="getStatusClass(ticket.status)">
                        {{ticket.status}}
                    </span>
                    <span class="meta-text">
                        Created on {{ticket.createdAt | date:'medium'}} by <strong>{{ticket.createdBy}}</strong>
                    </span>
                </div>
            </div>
            <div class="actions" *ngIf="!isLoading">
                <button mat-flat-button color="accent" *ngIf="canReopen()" (click)="reopen()">
                    <mat-icon>refresh</mat-icon> Reopen Ticket
                </button>
                <button mat-flat-button color="warn" *ngIf="canCancel()" (click)="cancel()">
                    <mat-icon>cancel</mat-icon> Cancel Ticket
                </button>
            </div>
        </div>
    </mat-card>

    <!-- STATUS STEPPER -->
    <div class="status-stepper-container fadeIn">
        <div class="stepper">
            <div class="step" [class.completed]="ticket.status !== 'Open'" [class.active]="ticket.status === 'Open'">
                <div class="step-circle"><mat-icon>radio_button_checked</mat-icon></div>
                <div class="step-label">Open</div>
                <div class="step-line"></div>
            </div>
            <div class="step" [class.completed]="ticket.status !== 'Open' && ticket.status !== 'Assigned'"
                [class.active]="ticket.status === 'Assigned'">
                <div class="step-circle"><mat-icon>person</mat-icon></div>
                <div class="step-label">Assigned</div>
                <div class="step-line"></div>
            </div>
            <div class="step" [class.completed]="ticket.status === 'Resolved' || ticket.status === 'Closed'"
                [class.active]="ticket.status === 'In Progress'">
                <div class="step-circle"><mat-icon>build</mat-icon></div>
                <div class="step-label">In Progress</div>
                <div class="step-line"></div>
            </div>
            <div class="step" [class.completed]="ticket.status === 'Closed'"
                [class.active]="ticket.status === 'Resolved'">
                <div class="step-circle"><mat-icon>check_circle</mat-icon></div>
                <div class="step-label">Resolved</div>
                <div class="step-line"></div>
            </div>
            <div class="step" [class.active]="ticket.status === 'Closed'">
                <div class="step-circle"><mat-icon>lock</mat-icon></div>
                <div class="step-label">Closed</div>
            </div>
        </div>
    </div>

    <div class="content-grid">

        <!-- Left Column: Details -->
        <div class="main-column">
            <mat-card class="details-card fadeIn">
                <mat-card-header>
                    <mat-card-title>Description</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                    <p class="description-text">{{ticket.description}}</p>

                    <mat-divider class="spacer"></mat-divider>

                    <div class="info-grid">
                        <div class="info-item">
                            <label>Category</label>
                            <span>{{ticket.category}}</span>
                        </div>
                        <div class="info-item">
                            <label>Assigned To</label>
                            <span>{{ticket.assignedTo || 'Unassigned'}}</span>
                        </div>
                    </div>

                    <!-- Resolution Section -->
                    <div class="resolution-box fadeIn" *ngIf="ticket.resolvedAt">
                        <mat-divider class="spacer"></mat-divider>
                        <h3><mat-icon color="primary">check_circle</mat-icon> Resolution</h3>
                        <p class="resolution-text">{{ticket.resolutionDetails || 'Resolved without specific details.'}}
                        </p>
                        <span class="meta-text">Resolved on {{ticket.resolvedAt | date:'medium'}}</span>
                    </div>
                </mat-card-content>
            </mat-card>

            <!-- Activity Logs -->
            <mat-card class="logs-card fadeIn">
                <mat-card-header>
                    <mat-card-title>Activity History</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                    <mat-list>
                        <div *ngFor="let log of ticket.activityLogs; let last = last">
                            <div class="log-item">
                                <mat-icon class="log-icon" color="primary">history</mat-icon>
                                <div class="log-content">
                                    <span class="log-action">{{log.action}}</span>
                                    <span class="log-meta">
                                        <span *ngIf="log.oldValue">{{getLogValue(log.oldValue, log.action)}} &rarr;
                                        </span>
                                        {{getLogValue(log.newValue, log.action)}}
                                    </span>
                                    <span class="log-date">{{log.createdAt | date:'short'}}</span>
                                </div>
                            </div>
                            <mat-divider *ngIf="!last"></mat-divider>
                        </div>
                    </mat-list>
                </mat-card-content>
            </mat-card>
        </div>

        <!-- Right Column: Discussion -->
        <div class="side-column">
            <mat-card class="comments-card fadeIn">
                <mat-card-header>
                    <mat-card-title>Discussion</mat-card-title>
                </mat-card-header>
                <mat-card-content>

                    <!-- Comment List -->
                    <div class="comments-list">
                        <div class="comment-item" *ngFor="let comment of ticket.comments">
                            <div class="comment-avatar">
                                {{comment.userName.charAt(0).toUpperCase()}}
                            </div>
                            <div class="comment-body">
                                <div class="comment-header">
                                    <strong>{{comment.userName}}</strong>
                                    <span class="time">{{comment.createdAt | date:'short'}}</span>
                                </div>
                                <div class="comment-text">{{comment.commentText}}</div>
                            </div>
                        </div>
                        <div *ngIf="ticket.comments.length === 0" class="no-comments">
                            No comments yet. Start the conversation!
                        </div>
                    </div>

                    <mat-divider class="spacer"></mat-divider>

                    <!-- Add Comment -->
                    <div class="add-comment-section">
                        <mat-form-field appearance="outline" class="full-width">
                            <mat-label>Add a comment...</mat-label>
                            <textarea matInput [(ngModel)]="newComment" rows="3"></textarea>
                        </mat-form-field>
                        <button mat-raised-button color="primary" [disabled]="!newComment.trim() || isSubmittingComment"
                            (click)="submitComment()">
                            Post Comment
                        </button>
                    </div>

                </mat-card-content>
            </mat-card>
        </div>

    </div>

</div>

<ng-template #loadingOrError>
    <div class="loading-container" *ngIf="isLoading">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        <p>Loading ticket details...</p>
    </div>
    <div class="error-container" *ngIf="!isLoading && !ticket">
        <h2>Ticket not found</h2>
        <p>The ticket you are looking for does not exist or you do not have permission to view it.</p>
        <button mat-button color="primary" routerLink="/dashboard">Back to Dashboard</button>
    </div>
</ng-template>