<div class="dashboard-container">

  <!-- Header -->
  <header class="dashboard-header">
    <div class="header-content">
      <h1>Manager Dashboard</h1>
      <p class="subtitle">Overview and Ticket Assignment</p>
    </div>
    <div class="actions">
      <button mat-raised-button color="primary" (click)="loadData()" matTooltip="Refresh Data">
        <mat-icon>refresh</mat-icon> Refresh
      </button>
    </div>
  </header>

  <mat-progress-bar mode="indeterminate" *ngIf="isLoading" class="loading-bar"></mat-progress-bar>

  <div class="dashboard-grid">

    <!-- Left Column: Tickets Tabs -->
    <div class="main-content">
      <mat-tab-group animationDuration="0ms">

        <!-- Tab 1: Unassigned -->
        <mat-tab label="Unassigned Tickets">
          <ng-template matTabContent>
            <div class="tab-content-wrapper">
              <div class="section-header">
                <h3>Incoming Tickets <span class="badge-count">{{totalCount}}</span></h3>
              </div>

              <div class="mat-elevation-z2 table-container">
                <table mat-table [dataSource]="unassignedTickets" matSort (matSortChange)="onSortChange($event)"
                  matSortActive="CreatedAt" matSortDirection="desc" matSortDisableClear>

                  <!-- ID Column -->
                  <ng-container matColumnDef="id">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header="TicketId"> ID </th>
                    <td mat-cell *matCellDef="let element"> #{{element.ticketId}} </td>
                  </ng-container>

                  <!-- Title Column -->
                  <ng-container matColumnDef="title">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header="Title"> Title </th>
                    <td mat-cell *matCellDef="let element"> {{element.title}} </td>
                  </ng-container>

                  <!-- Category Column -->
                  <ng-container matColumnDef="category">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header="TicketCategory.CategoryName"> Category </th>
                    <td mat-cell *matCellDef="let element"> {{element.category}} </td>
                  </ng-container>

                  <!-- Priority Column -->
                  <ng-container matColumnDef="priority">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header="TicketPriority.PriorityName"> Priority </th>
                    <td mat-cell *matCellDef="let element">
                      <span [class]="'priority-badge ' + getPriorityClass(element.priority)">{{element.priority}}</span>
                    </td>
                  </ng-container>

                  <!-- CreatedAt Column -->
                  <ng-container matColumnDef="createdAt">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header="CreatedAt"> Created </th>
                    <td mat-cell *matCellDef="let element"> {{element.createdAt | date:'short'}} </td>
                  </ng-container>

                  <!-- Assign Column -->
                  <ng-container matColumnDef="assign">
                    <th mat-header-cell *matHeaderCellDef> Assign To </th>
                    <td mat-cell *matCellDef="let element">
                      <mat-form-field appearance="outline" class="agent-select-compact">
                        <mat-select (selectionChange)="assign(element.ticketId, $event.value)"
                          placeholder="Select Agent">
                          <mat-option *ngFor="let a of agents" [value]="a.agentId">
                            {{ a.agentName }} ({{ a.totalAssigned }})
                          </mat-option>
                        </mat-select>
                      </mat-form-field>
                    </td>
                  </ng-container>

                  <!-- Actions Column -->
                  <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef> Action </th>
                    <td mat-cell *matCellDef="let element">
                      <button mat-icon-button color="primary" (click)="viewDetails(element.ticketId)"
                        matTooltip="View Details">
                        <mat-icon>visibility</mat-icon>
                      </button>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                </table>

                <mat-paginator [length]="totalCount" [pageSize]="pageSize" [pageSizeOptions]="[5, 10, 25, 50]"
                  (page)="onPageChange($event)" showFirstLastButtons>
                </mat-paginator>

                <div *ngIf="!isLoading && unassignedTickets.length === 0" class="empty-state-table">
                  No unassigned tickets.
                </div>
              </div>
            </div>
          </ng-template>
        </mat-tab>

        <!-- Tab 1.5: Escalated -->
        <mat-tab>
          <ng-template mat-tab-label>
            <span [matBadge]="escalatedTickets.length" matBadgeColor="warn"
              [matBadgeHidden]="escalatedTickets.length === 0" matBadgeOverlap="false">Escalated Tickets</span>
          </ng-template>
          <ng-template matTabContent>
            <div class="tab-content-wrapper escalated-wrapper">
              <div class="section-header">
                <h3 class="warn-text">⚠️ Escalated Tickets <span class="badge-count">{{escalatedTickets.length}}</span>
                </h3>
                <p class="subtitle warn-text">These tickets have breached SLA. Reassign or increase priority
                  immediately.</p>
              </div>

              <div class="mat-elevation-z2 table-container escalated-table-container">
                <table mat-table [dataSource]="escalatedTickets">

                  <!-- ID -->
                  <ng-container matColumnDef="id">
                    <th mat-header-cell *matHeaderCellDef> ID </th>
                    <td mat-cell *matCellDef="let element"> #{{element.ticketId}} </td>
                  </ng-container>

                  <!-- Title -->
                  <ng-container matColumnDef="title">
                    <th mat-header-cell *matHeaderCellDef> Title </th>
                    <td mat-cell *matCellDef="let element"> {{element.title}} </td>
                  </ng-container>

                  <!-- Priority (Editable) -->
                  <ng-container matColumnDef="priority">
                    <th mat-header-cell *matHeaderCellDef> Priority </th>
                    <td mat-cell *matCellDef="let element">
                      <mat-form-field appearance="outline" class="compact-select">
                        <mat-select [value]="element.ticketPriorityId"
                          (selectionChange)="changePriority(element.ticketId, $event.value)">
                          <mat-option *ngFor="let p of priorities" [value]="p.id">
                            {{ p.name }}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>
                    </td>
                  </ng-container>

                  <!-- Assigned To (Editable) -->
                  <ng-container matColumnDef="assignedTo">
                    <th mat-header-cell *matHeaderCellDef> Assigned Agent </th>
                    <td mat-cell *matCellDef="let element">
                      <mat-form-field appearance="outline" class="compact-select">
                        <mat-select [value]="element.assignedToId"
                          (selectionChange)="assign(element.ticketId, $event.value)" placeholder="Unassigned">
                          <mat-option [value]="null">Unassigned</mat-option>
                          <mat-option *ngFor="let a of agents" [value]="a.agentId">
                            {{ a.agentName }} ({{ a.totalAssigned }})
                          </mat-option>
                        </mat-select>
                      </mat-form-field>
                    </td>
                  </ng-container>

                  <!-- Created -->
                  <ng-container matColumnDef="createdAt">
                    <th mat-header-cell *matHeaderCellDef> Created </th>
                    <td mat-cell *matCellDef="let element"> {{element.createdAt | date:'short'}} </td>
                  </ng-container>

                  <!-- Actions -->
                  <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef> Action </th>
                    <td mat-cell *matCellDef="let element">
                      <button mat-icon-button color="primary" (click)="viewDetails(element.ticketId)"
                        matTooltip="View Details">
                        <mat-icon>visibility</mat-icon>
                      </button>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="escalatedColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: escalatedColumns;"></tr>
                </table>
                <div *ngIf="!isLoading && escalatedTickets.length === 0" class="empty-state-table">
                  No escalated tickets! Great job.
                </div>
              </div>
            </div>
          </ng-template>
        </mat-tab>

        <!-- Tab 2: Resolved -->
        <mat-tab label="Resolved Tickets (Verify)">
          <ng-template matTabContent>
            <div class="tab-content-wrapper">
              <div class="section-header">
                <h3>Resolved Tickets Pending Closure <span class="badge-count">{{resolvedTickets.length}}</span></h3>
              </div>

              <div class="mat-elevation-z2 table-container">
                <table mat-table [dataSource]="resolvedTickets">

                  <!-- ID Column -->
                  <ng-container matColumnDef="id">
                    <th mat-header-cell *matHeaderCellDef> ID </th>
                    <td mat-cell *matCellDef="let element"> #{{element.ticketId}} </td>
                  </ng-container>

                  <!-- Title Column -->
                  <ng-container matColumnDef="title">
                    <th mat-header-cell *matHeaderCellDef> Title </th>
                    <td mat-cell *matCellDef="let element"> {{element.title}} </td>
                  </ng-container>

                  <!-- Category Column -->
                  <ng-container matColumnDef="category">
                    <th mat-header-cell *matHeaderCellDef> Category </th>
                    <td mat-cell *matCellDef="let element"> {{element.category}} </td>
                  </ng-container>

                  <!-- Priority Column -->
                  <ng-container matColumnDef="priority">
                    <th mat-header-cell *matHeaderCellDef> Priority </th>
                    <td mat-cell *matCellDef="let element">
                      <span [class]="'priority-badge ' + getPriorityClass(element.priority)">{{element.priority}}</span>
                    </td>
                  </ng-container>

                  <!-- Assigned To -->
                  <ng-container matColumnDef="assignedTo">
                    <th mat-header-cell *matHeaderCellDef> Agent </th>
                    <td mat-cell *matCellDef="let element">
                      <div class="agent-chip">
                        <mat-icon inline="true" class="small-icon">person</mat-icon>
                        {{element.assignedTo}}
                      </div>
                    </td>
                  </ng-container>

                  <!-- CreatedAt Column -->
                  <ng-container matColumnDef="createdAt">
                    <th mat-header-cell *matHeaderCellDef> Created </th>
                    <td mat-cell *matCellDef="let element"> {{element.createdAt | date:'short'}} </td>
                  </ng-container>

                  <!-- Actions Column -->
                  <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef> Action </th>
                    <td mat-cell *matCellDef="let element">
                      <button mat-icon-button color="primary" (click)="viewDetails(element.ticketId)"
                        matTooltip="View Details">
                        <mat-icon>visibility</mat-icon>
                      </button>
                      <button mat-raised-button color="warn" class="close-btn" (click)="closeTicket(element.ticketId)"
                        matTooltip="Close Ticket">
                        <mat-icon>lock</mat-icon> Close
                      </button>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="resolvedColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: resolvedColumns;"></tr>
                </table>
                <div *ngIf="!isLoading && resolvedTickets.length === 0" class="empty-state-table">
                  No resolved tickets pending closure.
                </div>
              </div>
            </div>
          </ng-template>
        </mat-tab>

      </mat-tab-group>
    </div>

    <!-- Right Column: Agent Workload -->
    <div class="side-content">
      <div class="section-title">
        <h2>Agent Workload</h2>
      </div>

      <mat-card class="workload-card">
        <mat-list>
          <div *ngFor="let agent of agents" class="agent-item">
            <div class="agent-info">
              <span class="agent-name">{{agent.agentName}}</span>
              <span class="agent-status">{{agent.totalAssigned}} Tickets</span>
            </div>
            <!-- Simple visual indicator of load -->
            <div class="load-indicator">
              <div class="bar" [style.width.%]="(agent.totalAssigned * 10) + 5"></div>
            </div>
          </div>
        </mat-list>
      </mat-card>
    </div>

  </div>
</div>