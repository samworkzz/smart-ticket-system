<div class="reports-container" id="reportContent">
    <header class="reports-header">
        <div class="header-text">
            <h1>Support Manager Reports</h1>
            <p>Performance, Workload, and SLA Analytics</p>
        </div>
        <button mat-raised-button color="primary" (click)="downloadPdf()">
            <mat-icon>picture_as_pdf</mat-icon> Download PDF
        </button>
    </header>

    <mat-progress-bar mode="indeterminate" *ngIf="isLoading"></mat-progress-bar>

    <!-- KEY METRICS ROW -->
    <div class="metrics-summary" *ngIf="metrics">
        <mat-card class="summary-card">
            <div class="count">{{metrics.totalTickets}}</div>
            <div class="label">Total Tickets</div>
        </mat-card>
        <mat-card class="summary-card escalated">
            <div class="count">{{metrics.escalatedTickets}}</div>
            <div class="label">Total Escalated</div>
        </mat-card>
        <mat-card class="summary-card" [ngClass]="{'breach': metrics.slaComplianceRate < 80}">
            <div class="count">{{metrics.slaComplianceRate}}%</div>
            <div class="label">SLA Compliance</div>
        </mat-card>
        <mat-card class="summary-card info">
            <div class="count">{{metrics.averageResolutionTime}}h</div>
            <div class="label">Avg Resolution Time</div>
        </mat-card>
    </div>

    <div class="dashboard-grid" *ngIf="managerReport">

        <!-- ROW 1: Workload & SLA -->
        <div class="grid-row">
            <!-- AGENT WORKLOAD -->
            <mat-card class="chart-card wide">
                <mat-card-header>
                    <mat-card-title>Agent Workload Distribution</mat-card-title>
                    <mat-card-subtitle>Current Ticket Load (Open vs In Progress)</mat-card-subtitle>
                </mat-card-header>
                <div class="chart-wrapper">
                    <ngx-charts-bar-vertical-normalized [scheme]="colorScheme" [results]="workloadData"
                        [gradient]="false" [xAxis]="true" [yAxis]="true" [legend]="true" [showXAxisLabel]="true"
                        [showYAxisLabel]="true" xAxisLabel="Agent" yAxisLabel="Percentage of Load">
                    </ngx-charts-bar-vertical-normalized>
                    <!-- Note: Normalized shows ratio. If we want raw count, use bar-vertical-stacked or grouped -->
                </div>
                <!-- Alternative: Grouped Bar for raw counts -->
                <div class="chart-wrapper" *ngIf="false">
                    <ngx-charts-bar-vertical-2d [scheme]="colorScheme" [results]="workloadData" [gradient]="true"
                        [xAxis]="true" [yAxis]="true" [legend]="true" [showXAxisLabel]="true" [showYAxisLabel]="true"
                        xAxisLabel="Agent" yAxisLabel="Ticket Count">
                    </ngx-charts-bar-vertical-2d>
                </div>
            </mat-card>

            <!-- SLA COMPLIANCE -->
            <mat-card class="chart-card">
                <mat-card-header>
                    <mat-card-title>SLA Compliance Overview</mat-card-title>
                </mat-card-header>
                <div class="chart-wrapper">
                    <ngx-charts-pie-chart [scheme]="slaColorScheme" [results]="slaData" [gradient]="true"
                        [legend]="true" [labels]="true" [doughnut]="true">
                    </ngx-charts-pie-chart>
                </div>
            </mat-card>
        </div>

        <!-- ROW 2: Performance & At Risk -->
        <div class="grid-row">
            <!-- AGENT PERFORMANCE -->
            <mat-card class="chart-card wide">
                <mat-card-header>
                    <mat-card-title>Performance: Resolution Time</mat-card-title>
                    <mat-card-subtitle>Average hours to resolve tickets</mat-card-subtitle>
                </mat-card-header>
                <div class="chart-wrapper">
                    <ngx-charts-bar-vertical [scheme]="colorScheme" [results]="performanceData" [gradient]="true"
                        [xAxis]="true" [yAxis]="true" [legend]="false" [showXAxisLabel]="true" [showYAxisLabel]="true"
                        xAxisLabel="Agent" yAxisLabel="Avg Hours">
                    </ngx-charts-bar-vertical>
                </div>
            </mat-card>

            <!-- AT RISK TICKETS -->
            <mat-card class="chart-card list-card">
                <mat-card-header>
                    <mat-card-title>⚠️ At Risk Tickets</mat-card-title>
                    <mat-card-subtitle>Approaching SLA Breach (>75% time used)</mat-card-subtitle>
                </mat-card-header>
                <mat-card-content>
                    <div class="risk-list">
                        <div class="risk-item" *ngFor="let t of managerReport?.slaCompliance?.atRiskTickets">
                            <div class="risk-info">
                                <span class="risk-id">#{{t.ticketId}}</span>
                                <span class="risk-title">{{t.title}}</span>
                            </div>
                            <div class="risk-meta">
                                <span class="risk-agent">Owner: {{t.assignedTo}}</span>
                                <span class="risk-hours">{{t.hoursElapsed}} hrs elapsed</span>
                            </div>
                            <mat-progress-bar mode="determinate" value="85" color="warn"></mat-progress-bar>
                        </div>
                        <div *ngIf="managerReport?.slaCompliance?.atRiskTickets?.length === 0" class="no-risk">
                            <mat-icon>check_circle</mat-icon> No tickets currently at risk.
                        </div>
                    </div>
                </mat-card-content>
            </mat-card>
        </div>

    </div>
</div>